/**
 * @module promise
 * @author nuintun
 * @license MIT
 * @version 0.3.1
 * @description A pure JavaScript ES6 promise polyfill.
 * @see https://nuintun.github.io/promise#readme
 */
!function(){"use strict";function t(n){var e=this.constructor;return"function"!=typeof n?this:this.then(function(t){return e.resolve(n()).then(function(){return t})},function(t){return e.resolve(n()).then(function(){throw t})})}if("function"!=typeof window.Promise){var n=Function.prototype.toString.call(Function);n=(n=n.replace(/[\\^$.*+?()[\]{}|]/g,"\\$&")).replace(/Function|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?"),n=new RegExp("^"+n+"$");for(var e,i=window.MutationObserver||window.WebKitMutationObserver,r={support:function(){return m(i)},install:function(t){var n=!0,e=new i(t),r=document.createTextNode("");return e.observe(r,{characterData:!0}),function(){r.data=n=!n}}},o=window.VBArray,s=window.MessageChannel,a={support:function(){return!m(o)&&m(s)},install:function(t){var n=new s;return n.port1.onmessage=t,function(){n.port2.postMessage(0)}}},c={support:function(){return"onreadystatechange"in document.createElement("script")},install:function(n){return function(){var t=document.createElement("script");t.onreadystatechange=function(){n(),t.onreadystatechange=null,t.parentNode.removeChild(t),t=null},document.documentElement.appendChild(t)}}},u={support:function(){return!0},install:function(t){return function(){setTimeout(t,0)}}},f=[],l=!(b.prototype.run=function(){var t=this.task,n=this.args;switch(n.length){case 0:return t();case 1:return t(n[0]);case 2:return t(n[0],n[1]);case 3:return t(n[0],n[1],n[2]);default:return t.apply(null,n)}}),h=[r,a,c,u],p=0,d=h.length;p<d;p++)if((e=h[p]).support()){e=e.install(k);break}var v=Object.prototype.toString,w=E(Array.isArray)?Array.isArray:function(t){return"[object Array]"===v.call(t)},y=window.console,g=y&&y.error?y.error:function(){};P.prototype={fulfilled:function(t){"pending"===this.state&&(this.value=t,this.state="fulfilled"),"fulfilled"===this.state&&(this.notify(this.callbacks,this.value),this.callbacks=[],this.errbacks=null)},rejected:function(t){"pending"===this.state&&(this.value=t,this.state="rejected"),"rejected"===this.state&&(this.notify(this.errbacks,this.value),this.callbacks=null,this.errbacks=[])},resolve:function(t){var n=this;if("pending"===n.state){if(!t||"object"!=typeof t&&!E(t))return n.fulfilled(t);var e=!1;try{E(t.then)?t.then(function(t){e||(e=!0,n.resolve(t))},function(t){e||(e=!0,n.reject(t))}):n.fulfilled(t)}catch(r){e||n.rejected(r)}}},reject:function(t){"pending"===this.state&&this.rejected(t)},addCallbacks:function(t,n){var e=!1,r=this.callbacks,i=this.errbacks;if(r&&(e=!0,r.push(t)),i&&(e=!0,i.push(n)),e)switch(this.chained=e,this.state){case"fulfilled":this.fulfilled(this.value);break;case"rejected":this.rejected(this.value)}},notify:function(r,i){j(function(t){if(r.length)for(var n=0,e=r.length;n<e;++n)r[n](i);t.chained||"rejected"!==t.state||t.uncaught()},this)},uncaught:function(){var t=this.value;t instanceof Error?g("Uncaught",t.stack||t.name+": "+t.message):g("Uncaught Error:",t)}},A.name="Promise",A.prototype={constructor:A,then:function(t,n){var e,r,i=this["<resolver>"],o=new A(function(t,n){e=t,r=n});return i.addCallbacks(E(t)?T(o,e,r,t):e,E(n)?T(o,e,r,n):r),o},"catch":function(t){return this.then(void 0,t)},"finally":t},A.resolve=function(n){return n&&n instanceof A?n:new A(function(t){t(n)})},A.reject=function(e){return new A(function(t,n){n(e)})},A.all=function(a){return new A(function(e,t){if(!w(a))return t(new TypeError("Promise.all expects an array of values or promises"));var r=[],n=a.length;if(n<1)return e(r);var i=n;function o(n){return function(t){r[n]=t,0==--i&&e(r)}}for(var s=0;s<n;s++)A.resolve(a[s]).then(o(s),t)})},A.race=function(i){return new A(function(t,n){if(!w(i))return n(new TypeError("Promise.race expects an array of values or promises"));for(var e=0,r=i.length;e<r;e++)A.resolve(i[e]).then(t,n)})},window.Promise=A}else"function"!=typeof window.Promise.prototype["finally"]&&(window.Promise.prototype["finally"]=t);function m(t){return"function"==typeof t&&n.test(t)}function b(t,n){this.task=t,this.args=n}function k(){for(var t=0;t<f.length;t++)f[t].run();l=!(f=[])}function j(t){var n=function i(t,n){n>>>=0;var e=t.length;if(e<=n)return[];for(var r=new Array(e-n);e-- >n;)r[e-n]=t[e];return r}(arguments,1);f[f.length]=new b(t,n),l||(l=!0,e())}function E(t){return"function"==typeof t}function P(){this.callbacks=[],this.errbacks=[],this.state="pending",this.value=null,this.chained=!1}function A(t){if(!(this instanceof A))throw new TypeError(this+"is not a promise");if(!E(t))throw new TypeError("Promise resolver "+t+" is not a function");var n=new P;this["<resolver>"]=n;try{t(function(t){n.resolve(t)},function(t){n.reject(t)})}catch(e){n.reject(e)}}function T(r,i,o,s){return function(t){var n;try{n=s(t)}catch(e){return o(e)}if(n===r)return o(new TypeError("Cannot resolve a promise with itself"));i(n)}}}();
